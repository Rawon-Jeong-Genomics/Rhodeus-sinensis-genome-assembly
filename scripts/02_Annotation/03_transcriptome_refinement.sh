#!/bin/bash
# Description: Transcriptome-based gene structure refinement using PASA
# Journal: G3: Genes, Genomes, Genetics (Genome Report)
# Software: STAR v2.7.x (for alignment), PASA v2.4.1
# Evidence: RNA-seq data (R_sinensis_RNAseq_R1/R2)

# 1. Path Setup
GENOME_FASTA="rs_final_chromosome_level.fasta"
RNA_BAM="rs_rna_seq_aligned.bam" # BAM file generated by STAR
TRANSCRIPTS="Trinity.fasta"      # De novo assembly from Trinity
THREADS=32

echo "=========================================================="
echo "Step 1: Preparing PASA configuration and database"
echo "=========================================================="
# Note: PASA requires a MySQL/SQLite database and a configuration file (alignComplete.txt)
# Ensure your 'alignComplete.txt' is configured correctly for your local environment.

echo "=========================================================="
echo "Step 2: Running PASA Alignment Assembly Pipeline"
echo "=========================================================="
# -g: genomic DNA, -t: transcript sequences (Trinity), -c: config file
# --ALIGNERS: using blat and gmap (standard for PASA)
# --clean: cleans the database before running
/path/to/PASA/Launch_PASA_pipeline.pl \
    -c alignComplete.txt -C -R -g $GENOME_FASTA \
    -t $TRANSCRIPTS \
    --ALIGNERS blat,gmap \
    --CPU $THREADS

echo "=========================================================="
echo "Step 3: Integrating RNA-seq BAM for transcript refinement"
echo "=========================================================="
# PASA can utilize STAR-aligned BAM files to further validate splice junctions
# and improve gene models.
/path/to/PASA/scripts/upload_transcript_alignments_from_bam.pl \
    -g $GENOME_FASTA \
    -b $RNA_BAM \
    -N 100 \
    --st_db rs_pasa_db

echo "=========================================================="
echo "PASA refinement complete. Gene models are ready for EVM."
echo "=========================================================="
